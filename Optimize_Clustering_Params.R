require("Seurat")

liver.integrated <- readRDS("harmony_integrated.rds")

set.seed(7742)
# Dimensionality Reduction
require("sctransform")
#liver.integrated <- ScaleData(liver.integrated);
#liver.integrated <- RunPCA(liver.integrated, features = VariableFeatures(object = liver.integrated))
ElbowPlot(liver.integrated)

npcs <- 20

# Cluster with many different parameters
res <- seq(from=0.3, to=2, by=0.2)
nkNN <- seq(from=30, to=90, by=10)

for(res_param in res) {
for(nkNN_param in nkNN){
liver.integrated <- FindNeighbors(liver.integrated, reduction="harmony", dims = 1:npcs, k.param=nkNN_param)
liver.integrated <- FindClusters(liver.integrated, reduction="harmony", resolution = res_param, k.param=nkNN_param)
name <- paste("knn_",nkNN_param,"_res_", res_param, sep="");

liver.integrated@meta.data[[name]] <- liver.integrated@meta.data$seurat_clusters;

}}

# Compare all these clusterings
require(igraph)
require(gplots)
clust_table <- liver.integrated@meta.data[, grepl("^knn_", names(liver.integrated@meta.data))]
clust_table <- as.matrix(apply(clust_table,2,as.numeric))
require("proxy")
clust_dists <- proxy::dist(clust_table, method=function(x,y){igraph::compare(x,y,method="vi")}, by_rows=FALSE)
clust_similr1 <- proxy::simil(clust_table, method=function(x,y){igraph::compare(x,y,method="nmi")}, by_rows=FALSE)
clust_similr2 <- proxy::simil(clust_table, method=function(x,y){igraph::compare(x,y,method="adjusted.rand")}, by_rows=FALSE)


# Find robust exemplar clustering(s)
require("apcluster")
set.seed(18371)

res1 <- apcluster(-1*as.matrix(clust_dists))
res2 <- apcluster(as.matrix(clust_similr1))
res3 <- apcluster(as.matrix(clust_similr1))

valid_clusterings <- res1@exemplars[which(res1@exemplars %in% res2@exemplars & res1@exemplars %in% res3@exemplars)]

#manually select which exemplar to use
#liver.integrated@meta.data$Coarse_clusters <- liver.integrated@meta.data$knn_70_res_0.3 <- basic_integration_analysis.rds
#liver.integrated@meta.data$Fine_clusters <- liver.integrated@meta.data$knn_90_res_1.5 <- basic_integration_analysis.rds

png("compare_harmony_clusterings_heatmap.png", width=6, height=6, units="in", res=300)
apcluster::heatmap(res1, -1*as.matrix(clust_dists))
dev.off()

# Visualize the Chosen clusterings
nkNN <- 90
res <- 1.5

liver.integrated <- RunTSNE(liver.integrated, dims = 1:npcs)
liver.integrated <- RunUMAP(liver.integrated, dims = 1:npcs, parallel=FALSE, n.neighbour=nkNN)
png("Highres_harmony_integrated_umap.png", width=6, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "umap", group.by="Coarse_clusters")
dev.off()
png("Highres_harmony_integrated_tsne.png", width=6, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "tsne", group.by="Fine_clusters")
dev.off()
png("Donor_integrated_umap.png", width=6, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "umap", group.by="orig.ident")
dev.off()
png("Donor_integrated_tsne.png", width=6, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "tsne", group.by="orig.ident")
dev.off()

png("Coarse_harmony_clusters_by_donor.png", width=6, height=6, units="in", res=50)
barplot(table(liver.integrated@meta.data$orig.ident, liver.integrated@meta.data$Coarse_clusters), col=rainbow(20))
dev.off()
png("Fine_harmony_clusters_by_donor.png", width=6, height=6, units="in", res=50)
barplot(table(liver.integrated@meta.data$orig.ident, liver.integrated@meta.data$Fine_clusters), col=rainbow(20))
dev.off()

# Auto-annotation
source("Setup_autoannotation.R")

all_anno <- readRDS("All20_automatedannotation.rds");

liver.integrated@meta.data$scmap_anno <- rep("unknown", ncol(liver.integrated));
liver.integrated@meta.data$scmap_anno2 <- rep("unknown", ncol(liver.integrated));
for (donor in unique(liver.integrated@meta.data$orig.ident)) {
        cell_ids <- liver.integrated@meta.data$cell_barcode[liver.integrated@meta.data$donor == donor]
        anno <- all_anno[[donor]];
        anno <- anno[anno$cell_barcode %in% cell_ids,]
        anno <- anno[match(cell_ids, anno$cell_barcode),]
        liver.integrated@meta.data$scmap_anno[liver.integrated@meta.data$orig.ident == donor] <- as.character(anno$scmap_cluster_anno$lm1)
        liver.integrated@meta.data$scmap_anno2[liver.integrated@meta.data$orig.ident == donor] <- as.character(anno$scmap_cell_anno)
}

png("AutoAnno_harmony_integrated_umap.png", width=8, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "umap", group.by="scmap_anno")
dev.off()
png("AutoAnno_harmony_integrated_tsne.png", width=8, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "tsne", group.by="scmap_anno")
dev.off()
png("AutoAnno2_harmony_integrated_umap.png", width=8, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "umap", group.by="scmap_anno2")
dev.off()
png("AutoAnno2_harmony_integrated_tsne.png", width=8, height=6, units="in", res=50)
DimPlot(liver.integrated, reduction = "tsne", group.by="scmap_anno2")
dev.off()

saveRDS(liver.integrated, "integration_harmony_plus_analysis.rds")

# Would this be helpful?
# create a heatmap where: cell = average similarity of this clustering to all other clusterings
# distance between clusterings is measured using igraph::compare(c1, c2, method="vi")

